mport os
import random
from datetime import datetime
from collections import defaultdict

import yt_dlp
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Application, MessageHandler, CommandHandler, ContextTypes, filters
from telegram.request import HTTPXRequest
from telegram.constants import ChatAction


# =========================
# –ù–ê–°–¢–†–û–ô–ö–ò
# =========================
TOKEN = os.environ.get("BOT_TOKEN", "").strip() or "8330678502:AAGd0sPQk0YbvVHyrQGNCUCRHu1ZE9b6n2w"
DOWNLOAD_DIR = "downloads"
os.makedirs(DOWNLOAD_DIR, exist_ok=True)

# –¢–∞–π–º–∞—É—Ç—ã (—á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤)
request = HTTPXRequest(
    connect_timeout=30,
    read_timeout=300,
    write_timeout=300,
    pool_timeout=30,
)

# –ö–Ω–æ–ø–∫–∏
keyboard = ReplyKeyboardMarkup(
    [["üéß –°–∫–∞—á–∞—Ç—å –±–∏—Ç (–ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏ —Å—Å—ã–ª–∫—É)", "‚ÑπÔ∏è –ß—Ç–æ —É–º–µ–µ—Ç –±–æ—Ç"]],
    resize_keyboard=True
)

# –°—á—ë—Ç—á–∏–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π (–∂–∏–≤—ë—Ç –ø–æ–∫–∞ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç)
user_stats = defaultdict(int)


# =========================
# –ú–û–¢–ò–í–ê–¶–ò–Ø (–û–ß–ï–ù–¨ –ú–ù–û–ì–û –í–ê–†–ò–ê–ù–¢–û–í)
# =========================
STARTS = [
    "{name}, –±—Ä–∞—Ç", "{name}, —Å–ª—É—à–∞–π —Å—é–¥–∞", "{name}, –º–æ–º–µ–Ω—Ç –Ω–∞—Å—Ç–∞–ª", "{name}, —â–∞ –±—É–¥–µ—Ç –∂–∞—Ä–∞",
    "{name}, –Ω–µ –º–æ—Ä–≥–∞–π", "{name}, —Å–æ–±–µ—Ä–∏—Å—å", "{name}, –≤–∫–ª—é—á–∞–π —Ä–µ–∂–∏–º –∑–≤–µ—Ä—è", "{name}, –ø–æ —Ñ–∞–∫—Ç—É",
    "{name}, –≤—Ä–µ–º—è –ø—Ä–∏—à–ª–æ", "{name}, –¥–∞–≤–∞–π –ø–æ-–≤–∑—Ä–æ—Å–ª–æ–º—É",
]

VERBS = [
    "—Ä–∞–∑—ä–µ–±–∏", "—É–Ω–∏—á—Ç–æ–∂—å", "—Ä–∞–∑–Ω–µ—Å–∏", "—Å–æ—Ç—Ä–∏", "—Å–æ–∂—Ä–∏", "—Ä–∞–∑–æ—Ä–≤–∏", "—Ä–∞—Å–∫–∞—Ç–∞–π", "–ø–æ—Ä–≤–∏—Å—å",
    "–ø—Ä–∏—Ö–ª–æ–ø–Ω–∏", "–∑–∞–¥—É—à–∏", "–∑–∞–±–µ—Ä–∏", "–≤—ã–Ω–µ—Å–∏", "—Å–ª–æ–º–∞–π", "—Ä–∞–∑–¥–∞–≤–∏"
]

TARGETS = [
    "—ç—Ç–æ—Ç –±–∏—Ç", "—ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª", "—ç—Ç—É –º–∏–Ω—É—Å–æ–≤–∫—É", "—ç—Ç—É –¥–æ—Ä–æ–∂–∫—É", "—ç—Ç—É –æ—Å–Ω–æ–≤—É", "—ç—Ç–æ –¥–µ—Ä—å–º–æ", "—ç—Ç–æ—Ç –≥—Ä—É–≤"
]

STYLE = [
    "–±–µ–∑ –∂–∞–ª–æ—Å—Ç–∏", "–∫–∞–∫ –±—É–¥—Ç–æ —Ç–µ–±–µ –∑–∞ —ç—Ç–æ –ø–ª–∞—Ç—è—Ç", "–∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å",
    "—Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ç—É–¥–∏—è –≤—Å–ø–æ—Ç–µ–ª–∞", "—Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ç–µ–Ω—ã –¥—Ä–æ–∂–∞–ª–∏", "—Ç–∞–∫, —á—Ç–æ–±—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –º–æ–ª—á–∞–ª–∏",
    "—Ç–∞–∫, —á—Ç–æ–±—ã —Å–æ—Å–µ–¥–∏ –∑–Ω–∞–ª–∏, —á—Ç–æ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å", "–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª–∫–∞—Ö", "–≤ –Ω–æ–ª—å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–æ–≤",
]

PUNCH = [
    "–ø—É—Å—Ç—å —É –ª—é–¥–µ–π —á–µ–ª—é—Å—Ç—å —É–ø–∞–¥—ë—Ç", "–ø—É—Å—Ç—å —ç—Ç–æ —Å—Ç–∞–Ω–µ—Ç —Ö–∏—Ç–æ–º", "–ø—É—Å—Ç—å —ç—Ç–æ —Å—Ç–∞–Ω–µ—Ç –ª–µ–≥–µ–Ω–¥–æ–π",
    "–ø—É—Å—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã —É–¥–∞–ª—è—Ç –ø—Ä–æ–µ–∫—Ç—ã", "–ø—É—Å—Ç—å —ç—Ç–æ –±—É–¥–µ—Ç —Ä–∞–∑–Ω–æ—Å —Å–µ–∑–æ–Ω–∞", "–ø—É—Å—Ç—å —ç—Ç–æ –±—É–¥–µ—Ç –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–æ –∑–≤—É–∫—É",
    "–ø—É—Å—Ç—å —ç—Ç–æ –±—É–¥–µ—Ç –∑–≤—É–∫, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∑–∞–±—ã–≤–∞—é—Ç", "–ø—É—Å—Ç—å —ç—Ç–æ –±—É–¥–µ—Ç —Ç—Ä–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –±–æ—è—Ç—Å—è —Å—Ç–∞–≤–∏—Ç—å"
]

EMOJI = ["üî•", "üí£", "üéß", "üé§", "üòà", "‚ö°", "üß®", "üöÄ", "üíÄ", "ü•∂", "ü©∏"]

DAY_LINES = [
    "–î–Ω—ë–º —Ç–æ–∂–µ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≥—Ä—è–∑—å, {name}. –î–∞–≤–∞–π –∫—Ä–∞—Å–∏–≤–æ ‚òÄÔ∏è",
    "{name}, –¥–Ω–µ–≤–Ω–æ–π —Ä–µ–∂–∏–º ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –¥—Ä—É–≥–æ–π –≤–∏–¥ —Ä–∞–∑—ä—ë–±–∞ ‚òÄÔ∏è",
    "{name}, —Å–µ–≥–æ–¥–Ω—è –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å —Å—Ü–µ–Ω—É üèÜ",
    "{name}, –≤–∫–ª—é—á–∞–π —Å–≤–µ—Ç –∏ –¥–µ–ª–∞–π —Ç–µ–Ω—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º ‚òÄÔ∏è",
]

NIGHT_LINES = [
    "{name}, –Ω–æ—á—å —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è —Ç—ë–º–Ω—ã—Ö —Ö–∏—Ç–æ–≤ üåô",
    "{name}, —â–∞ –±—É–¥–µ—Ç —Ç—ë–º–Ω—ã–π —Ñ–ª–æ—É, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –¥—Ä–æ–∂–∞—Ç —Å—Ç–µ–Ω—ã üñ§",
    "{name}, –Ω–æ—á—å, —Å—Ç—É–¥–∏—è –∏ —Ç—ã ‚Äî –∏–¥–µ–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ üòà",
    "{name}, –Ω–æ—á—å—é –±–∏—Ç—ã —É–º–∏—Ä–∞—é—Ç –≥—Ä–æ–º—á–µ üåô",
]

RARE_HYPE = [
    "ü©∏ {name}, –≠–¢–û–¢ –ë–ò–¢ –ë–´–õ –ñ–ò–í –î–û –í–°–¢–†–ï–ß–ò –° –¢–û–ë–û–ô. –ë–û–õ–¨–®–ï –ù–ï–¢.",
    "üëë {name}, —Å–µ–≥–æ–¥–Ω—è —Ç—ã –Ω–µ –∞—Ä—Ç–∏—Å—Ç. –°–µ–≥–æ–¥–Ω—è —Ç—ã —Å–æ–±—ã—Ç–∏–µ.",
    "üö® {name}, –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ç—Ä–µ–∫–∞ –∏–Ω–¥—É—Å—Ç—Ä–∏—è —É–∂–µ –Ω–µ –±—É–¥–µ—Ç –ø—Ä–µ–∂–Ω–µ–π.",
    "üíÄ {name}, —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª —Å–æ–≤–µ—Ä—à–∏–ª –æ—à–∏–±–∫—É, –∫–æ–≥–¥–∞ –≤—Å—Ç—Ä–µ—Ç–∏–ª —Ç–µ–±—è.",
    "üî• {name}, —â–∞—Å —Ä–æ–¥–∏—Ç—Å—è –∑–≤—É–∫, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥—É—Ç –≤—Å–ø–æ–º–∏–Ω–∞—Ç—å –≥–æ–¥–∞–º–∏.",
    "‚ö° {name}, —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–¥–Ω—è–ª –ø–ª–∞–Ω–∫—É. –í—Å–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–º ‚Äî —É–¥–∞—á–∏.",
    "üß® {name}, —ç—Ç–æ –Ω–µ –∑–∞–ø–∏—Å—å. –≠—Ç–æ –∑–∞—Ö–≤–∞—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏.",
]

def generate_hype(name: str, count: int) -> str:
    hour = datetime.now().hour

    # 5% —à–∞–Ω—Å –Ω–∞ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—É—é —Ñ—Ä–∞–∑—É
    if random.random() < 0.05:
        return random.choice(RARE_HYPE).format(name=name)

    day_or_night = random.choice(DAY_LINES if 6 <= hour < 20 else NIGHT_LINES).format(name=name)

    # 2 —Å—Ç—Ä–æ–∫–∏: —Å–±–æ—Ä–∫–∞ –∏–∑ —á–∞—Å—Ç–µ–π = –º–∏–ª–ª–∏–æ–Ω—ã –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
    line1 = f"{random.choice(STARTS).format(name=name)} ‚Äî {random.choice(VERBS)} {random.choice(TARGETS)} {random.choice(STYLE)} {random.choice(EMOJI)}"
    line2 = f"–ò –¥–∞: {random.choice(PUNCH)} {random.choice(EMOJI)}"

    stat = f"\nüíø –¢—ã —É–∂–µ –∑–∞–±—Ä–∞–ª {count} –±–∏—Ç(–æ–≤) –∑–∞ —ç—Ç—É —Å–µ—Å—Å–∏—é. –ú–∞—à–∏–Ω–∞."

    return day_or_night + "\n" + line1 + "\n" + line2 + stat


# =========================
# –•–≠–ù–î–õ–ï–†–´
# =========================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üëã –ü—Ä–∏–≤–µ—Ç!\n\n"
        "–Ø –±–æ—Ç –¥–ª—è –∞—Ä—Ç–∏—Å—Ç–æ–≤: –∫–∞—á–∞—é –±–∏—Ç—ã —Å YouTube –∏ –æ—Ç–¥–∞—é MP3 320 kbps.\n\n"
        "‚úÖ –ü—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube.",
        reply_markup=keyboard
    )

async def info_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "‚ÑπÔ∏è –ß—Ç–æ —è –¥–µ–ª–∞—é:\n"
        "‚Ä¢ –ø—Ä–∏–Ω–∏–º–∞—é —Å—Å—ã–ª–∫—É –Ω–∞ YouTube\n"
        "‚Ä¢ —Å–∫–∞—á–∏–≤–∞—é –ª—É—á—à–µ–µ –∞—É–¥–∏–æ\n"
        "‚Ä¢ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é –≤ MP3 320 kbps\n"
        "‚Ä¢ –æ—Ç–ø—Ä–∞–≤–ª—è—é —Ñ–∞–π–ª –≤ —á–∞—Ç\n"
        "‚Ä¢ –ø–æ—Å–ª–µ ‚Äî –¥–∞—é –∂—ë—Å—Ç–∫—É—é –º–æ—Ç–∏–≤–∞—Ü–∏—é üòà\n\n"
        "–ü—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏ —Å—Å—ã–ª–∫—É."
    )

def looks_like_youtube(url: str) -> bool:
    u = url.lower()
    return ("youtube.com/" in u) or ("youtu.be/" in u)

async def convert_and_send(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (update.message.text or "").strip()

    if text == "‚ÑπÔ∏è –ß—Ç–æ —É–º–µ–µ—Ç –±–æ—Ç":
        await info_cmd(update, context)
        return

    # –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–∫–∏
    if not looks_like_youtube(text):
        await update.message.reply_text("–°–∫–∏–Ω—å —Å—Å—ã–ª–∫—É –∏–º–µ–Ω–Ω–æ –Ω–∞ YouTube (youtube.com –∏–ª–∏ youtu.be).")
        return

    url = text
    await update.message.reply_text("üéµ –°–∫–∞—á–∏–≤–∞—é –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é –≤ MP3 320kbps...")

    ydl_opts = {
        "format": "bestaudio/best",
        "outtmpl": f"{DOWNLOAD_DIR}/%(id)s.%(ext)s",
        "postprocessors": [{
            "key": "FFmpegExtractAudio",
            "preferredcodec": "mp3",
            "preferredquality": "320",
        }],
        "concurrent_fragment_downloads": 8,  # —É—Å–∫–æ—Ä—è–µ—Ç –Ω–∞ –º–Ω–æ–≥–∏—Ö –≤–∏–¥–µ–æ
        "retries": 5,
        "fragment_retries": 5,
        "socket_timeout": 30,
        "quiet": True,
    }

    mp3_file = None
    title = "audio"

    try:
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=True)
            vid = info.get("id")
            title = info.get("title", "audio")

            if not vid:
                await update.message.reply_text("‚ùå –ù–µ —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ.")
                return

            mp3_file = f"{DOWNLOAD_DIR}/{vid}.mp3"

        await context.bot.send_chat_action(update.effective_chat.id, ChatAction.UPLOAD_DOCUMENT)

        if not mp3_file or not os.path.exists(mp3_file):
            await update.message.reply_text("‚ùå MP3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ ffmpeg –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ.")
            return

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –æ–±—ã—á–Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –∏ –±—ã—Å—Ç—Ä–µ–µ
        safe_name = "".join(c for c in title if c not in '\\/:*?"<>|').strip()[:80] or "audio"
        with open(mp3_file, "rb") as f:
            await update.message.reply_document(
                document=f,
                filename=f"{safe_name}.mp3",
                read_timeout=300,
                write_timeout=300,
                connect_timeout=30,
                pool_timeout=30,
            )

        # –ú–æ—Ç–∏–≤–∞—Ü–∏—è + —Å—á—ë—Ç—á–∏–∫
        user = update.effective_user
        name = user.first_name or "–ë—Ä–∞—Ç"
        user_stats[user.id] += 1

        await update.message.reply_text(generate_hype(name, user_stats[user.id]))

    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {e}")

    finally:
        # —á–∏—Å—Ç–∏–º —Ñ–∞–π–ª
        try:
            if mp3_file and os.path.exists(mp3_file):
                os.remove(mp3_file)
        except:
            pass


def main():
    if TOKEN == "8330678502:AAGd0sPQk0YbvVHyrQGNCUCRHu1ZE9b6n2w":
        print("‚ö†Ô∏è –í—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω –≤ TOKEN –∏–ª–∏ –∑–∞–¥–∞–π –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN.")
    print("BOT STARTED ‚úÖ")

    app = Application.builder().token(TOKEN).request(request).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("info", info_cmd))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, convert_and_send))
    app.run_polling()

if __name__ == "__main__":
    main()
